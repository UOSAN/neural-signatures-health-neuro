---
title: "WTP analyses"
author: "Dani Cosme"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: show
    df_print: paged
    highlight: tango
    theme: united
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.path = "figs/", dpi = 300, colormodel = "cmyk")
options(scipen = 999)
```

# load packages
```{r}
library(tidyverse)
library(lme4)
library(lmerTest)
library(knitr)
library(MuMIn)
library(cowplot)
library(broom)
```

# define color palettes
```{r}
algorithm = c("#006989", "#FEC601", "#F43C13", "#00A5CF", "#00A878")
food = c("#A4C960", "#2A5C8C")
liking = c("#FF0000", "#F2AD00")
bid = c("#00A08A", "#F2AD00", "#F98400", "#FF0000", "#A80000")
dc_bw = readRDS("~/dc_bw.Rds") +
    theme(text = element_text(size = 13, family = "Futura Medium"))
```

# load and tidy data
```{r}
dev = readRDS("FV_near_validation.RDS") %>%
  mutate(sample = "near validation",
         run = "run1") %>%
  select(sample, subjectID, run, trial, health, bid, rt, algorithm, dotProduct, dotSTD)

val = readRDS("FV_far_validation.RDS") %>%
  mutate(sample = "far validation") %>%
  filter(!liking_rating < 1) %>%
  select(sample, subjectID, run, trial, health, liking, bid, rt, algorithm, dotProduct, dotSTD)

data = bind_rows(dev, val) %>%
  arrange(subjectID, trial) %>%
  filter(!is.na(bid)) %>%
  mutate(sample = factor(sample, levels = c("near validation", "far validation")))
```

# descriptives
## number of participants
```{r}
data %>%
  filter(algorithm == "logistic classifier") %>%
  select(sample, subjectID) %>%
  unique() %>%
  group_by(sample) %>%
  summarize(n = n())
```

## ratings
```{r}
data %>%
  filter(algorithm == "logistic classifier") %>%
  group_by(sample, health) %>%
  summarize(n = n(),
            mean = round(mean(bid, na.rm = TRUE), 2),
            sd = round(sd(bid, na.rm = TRUE), 2),
            min = min(bid, na.rm = TRUE),
            max = max(bid, na.rm = TRUE))

data %>%
  filter(algorithm == "logistic classifier") %>%
  group_by(sample, health) %>%
  summarize(n = n(),
            mean = round(mean(bid, na.rm = TRUE), 2),
            sd = round(sd(bid, na.rm = TRUE), 2)) %>%
  gather(variable, value, mean, sd, n) %>%
  unite(sample, c(sample, variable), sep = " ") %>%
  spread(sample, value) %>%
  kable(format = "pandoc")
```

## pattern expression values
```{r, fig.width=7, fig.height=7}
data %>%
  group_by(sample, algorithm, health) %>%
  summarize(n = n(),
            mean = round(mean(dotSTD, na.rm = TRUE), 2),
            sd = round(sd(dotSTD, na.rm = TRUE), 2),
            min = min(dotSTD, na.rm = TRUE),
            max = max(dotSTD, na.rm = TRUE))

data %>%
  group_by(sample, algorithm, health) %>%
  summarize(n = n(),
            mean = round(mean(dotSTD, na.rm = TRUE), 2),
            sd = round(sd(dotSTD, na.rm = TRUE), 2)) %>%
  gather(variable, value, mean, sd) %>%
  unite(algorithm, c(algorithm, variable), sep = " ") %>%
  spread(algorithm, value) %>%
  group_by(sample, health) %>%
  fill(everything(), .direction = "up") %>%
  fill(everything(), .direction = "down") %>%
  unique() %>%
  kable(format = "pandoc")

a = data %>%
  group_by(health, sample, algorithm) %>%
  mutate(mean = mean(dotSTD, na.rm = TRUE)) %>%
  ggplot(aes(dotSTD, fill = health)) +
    geom_vline(aes(xintercept = mean, color = health), alpha = .7) +
    geom_density(color = NA, alpha = .7) +
    facet_grid(sample~algorithm, scales = "free_x") +
    scale_fill_manual(name = "", values = food) + 
    scale_color_manual(name = "", values = food) + 
    scale_y_continuous(expand = c(0, 0), breaks = scales::pretty_breaks(3)) +
    scale_x_continuous(breaks = scales::pretty_breaks(3)) +
    labs(x = "\nstandardized regulation PEV", y = "density\n") + 
    dc_bw +
    theme(legend.position = c(.74, .915))

b = data %>%
  group_by(algorithm, subjectID, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE)) %>%
  group_by(health, sample, algorithm) %>%
  mutate(mean = mean(meanPEV, na.rm = TRUE)) %>%
  ggplot(aes(meanPEV, fill = health)) +
    geom_vline(aes(xintercept = mean, color = health), alpha = .7) +
    geom_density(color = NA, alpha = .7) +
    facet_grid(sample~algorithm, scales = "free_x") +
    scale_fill_manual(name = "", values = food) + 
    scale_color_manual(name = "", values = food) + 
    scale_y_continuous(expand = c(0, 0), breaks = scales::pretty_breaks(3)) +
    scale_x_continuous(breaks = scales::pretty_breaks(3)) +
    labs(x = "\nparticipant mean standardized regulation PEV", y = "density\n") + 
    dc_bw +
    theme(legend.position = "none")

plot_grid(a, b, ncol = 1, align = "v", labels = c('A', 'B'))

data %>%
  select(sample, subjectID, trial, algorithm, dotSTD) %>%
  spread(algorithm, dotSTD) %>%
  mutate(subjectID = as.factor(subjectID)) %>%
  unique() %>%
  ungroup() %>%
  nest(-c(sample)) %>% 
  mutate(`logistic classifier_regulate > look` = map(data, ~ rmcorr::rmcorr(subjectID, `logistic classifier`, `regulate > look`, .)),
         `regulate > rest_logistic classifier` = map(data, ~ rmcorr::rmcorr(subjectID, `logistic classifier`, `regulate > rest`, .)),
         `regulate > look_regulate > rest` = map(data, ~ rmcorr::rmcorr(subjectID, `regulate > rest`, `regulate > look`, .))) %>%
  gather(test, model, contains("reg")) %>%
  group_by(sample, test) %>%
  mutate(r = sprintf("%s [%s, %s]", round(model[[1]][[1]], 2), round(model[[1]][[4]][1], 2), round(model[[1]][[4]][2], 2)),
         df = model[[1]][[2]],
         p = round(model[[1]][[3]], 3),
         p = ifelse(p == 0, "< .001", as.character(p))) %>%
  ungroup() %>%
  select(sample, test, r, df) %>%
  extract(test, c("var1", "var2"), "(.*)_(.*)") %>%
  spread(var1, r) %>%
  select(sample, var2, df, `regulate > rest`, everything()) %>%
  kable(format = 'pandoc')
```

# visualize
## health
```{r}
data %>%
  ggplot(aes(algorithm, dotSTD, fill = health)) +
    stat_summary(fun.y = mean, geom = "bar", position = position_dodge(width = 0.95)) +
    stat_summary(fun.data = mean_cl_boot, geom = "errorbar", position = position_dodge(width = 0.95), width = 0) +
    facet_grid(~sample) +
    scale_fill_manual(name = "", values = food) + 
    labs(y = "standarized regulation PEV\n", x = "") + 
    dc_bw

data %>%
  ggplot(aes(health, dotSTD)) +
    stat_summary(aes(group = subjectID), fun.y = mean, geom = "line", alpha = .1, size = .5) +
    stat_summary(aes(group = 1), fun.y = mean, geom = "line", size = .75) +
    stat_summary(aes(color = health), fun.data = mean_cl_boot, geom = "pointrange", width = 0) + 
    facet_wrap(sample~algorithm) +
    scale_color_manual(name = "", values = food) + 
    labs(y = "standarized regulation PEV\n", x = "") + 
    dc_bw
```

## health and liking in validation sample
```{r}
data %>%
  filter(sample == "far validation") %>%
  ggplot(aes(algorithm, dotSTD, fill = health, alpha = liking)) +
    stat_summary(fun.y = mean, geom = "bar", position = position_dodge(width = 0.95)) +
    stat_summary(fun.data = mean_cl_boot, geom = "errorbar", position = position_dodge(width = 0.95), width = 0) +
    scale_fill_manual(name = "", values = food) + 
    scale_alpha_discrete(range = c(.6,1)) +
    labs(y = "standarized regulation PEV\n", x = "") + 
    dc_bw

data %>%
  filter(sample == "far validation") %>%
  ggplot(aes(liking, dotSTD)) +
    stat_summary(aes(group = interaction(subjectID, health), color = health), fun.y = mean, geom = "line", alpha = .1, size = .5) +
    stat_summary(aes(group = health, color = health), fun.y = mean, geom = "line", size = .75) +
    stat_summary(aes(color = health), fun.data = mean_cl_boot, geom = "pointrange", width = 0) + 
    facet_grid(~algorithm) +
    scale_color_manual(name = "", values = food) + 
    coord_cartesian(ylim = c(-1.2, 1.2)) + 
    labs(y = "standarized regulation PEV\n", x = "") + 
    dc_bw
```

## health combined
```{r, fig.width=10, fig.height=8.5}
a = data %>%
  ggplot(aes(health, dotSTD, fill = health, alpha = sample)) +
    stat_summary(fun.y = mean, geom = "bar", position = position_dodge(width = 0.95)) +
    stat_summary(fun.data = mean_cl_boot, geom = "errorbar", position = position_dodge(width = 0.95), width = 0) +
    facet_grid(~algorithm) +
    scale_fill_manual(name = "", values = food) + 
    scale_alpha_discrete(name = "", range = c(.6, 1)) +
    scale_y_continuous(breaks = scales::pretty_breaks(3)) +
    labs(y = "standardized regulation PEV\n", x = "") + 
    dc_bw +
    theme(legend.position = c(.325 , .925),
          legend.box = "horizontal",
          text = element_text(size = 12),
          legend.spacing.x = unit(0.1, 'cm'))
  
b = data %>%
  filter(!is.na(bid)) %>%
  ggplot(aes(health, dotSTD)) +
    stat_summary(aes(group = subjectID), fun.y = mean, geom = "line", alpha = .1, size = .5) +
    stat_summary(aes(group = 1), fun.y = mean, geom = "line", size = .75) +
    stat_summary(aes(color = health), fun.data = mean_cl_boot,  geom = "pointrange", width = 0) + 
    facet_grid(sample~algorithm) +
    scale_color_manual(name = "", values = food) +
    scale_y_continuous(breaks = scales::pretty_breaks(3)) +
    coord_cartesian(ylim = c(-1.1, 1)) +
    labs(y = "standardized regulation PEV\n", x = "") + 
    dc_bw +
    theme(legend.position = "none",
          text = element_text(size = 12))

c = data %>%
  filter(sample == "far validation") %>%
  ggplot(aes(liking, dotSTD, fill = health)) +
    stat_summary(fun.y = mean, geom = "bar", position = position_dodge(width = 0.95)) +
    stat_summary(fun.data = mean_cl_boot, geom = "errorbar", position = position_dodge(width = 0.95), width = 0) +
    facet_grid(~algorithm) +
    scale_fill_manual(name = "", values = food) + 
    scale_alpha_discrete(name = "", range = c(.6, 1)) +
    scale_y_continuous(breaks = scales::pretty_breaks(3)) +
    labs(y = "standardized regulation PEV\n", x = "") + 
    dc_bw +
    theme(legend.position = c(.15, .925),
          legend.box = "horizontal",
          text = element_text(size = 12))

d = data %>%
  filter(sample == "far validation") %>%
  ggplot(aes(liking, dotSTD)) +
    stat_summary(aes(group = interaction(subjectID, health), color = health), fun.y = mean, geom = "line", alpha = .1, size = .5) +
    stat_summary(aes(group = health, color = health), fun.y = mean, geom = "line", size = .75) +
    stat_summary(aes(color = health), fun.data = mean_cl_boot, geom = "pointrange", width = 0) + 
    facet_grid(~algorithm) +
    scale_color_manual(name = "", values = food) + 
    scale_y_continuous(breaks = scales::pretty_breaks(3)) +
    coord_cartesian(ylim = c(-1.1, 1)) + 
    labs(y = "standarized regulation PEV\n", x = "") + 
    dc_bw +
    theme(legend.position = "none",
          text = element_text(size = 12))

plot_grid(a, b, c, d, ncol = 2, align = "v", labels = c('A', 'B', 'C', 'D'))
```

## bid value
```{r}
data %>%
  ggplot(aes(algorithm, dotSTD, fill = as.factor(bid))) +
    stat_summary(fun.y = mean, geom = "bar", position = position_dodge(width = 0.95)) +
    stat_summary(fun.data = mean_cl_boot, geom = "errorbar", position = position_dodge(width = 0.95), width = 0) +
    scale_fill_manual(name = "", values = bid) + 
    facet_grid(~sample) + 
    labs(y = "standarized regulation PEV\n", x = "") + 
    dc_bw

data %>%
  group_by(sample, bid, algorithm) %>%
  mutate(n.obs = n()) %>%
  ggplot(aes(as.factor(bid), dotSTD, color = algorithm)) +
    stat_summary(aes(group = algorithm), fun.y = mean, geom = "line") +
    stat_summary(fun.data = mean_cl_boot, geom = "linerange") +
    stat_summary(aes(size = n.obs), fun.y = mean, geom = "point") +
    scale_color_manual(name = "", values = algorithm) + 
    scale_size(name = "", range = c(1,4)) + 
    facet_grid(~sample, scales = "free_x") + 
    labs(x = "\nbid value", y = "standardized regulation PEV\n") + 
    dc_bw

data %>%
  ggplot(aes(algorithm, dotSTD, fill = as.factor(bid))) +
    stat_summary(fun.y = mean, geom = "bar", position = position_dodge(width = 0.95)) +
    stat_summary(fun.data = mean_cl_boot, geom = "errorbar", position = position_dodge(width = 0.95), width = 0) +
    scale_fill_manual(name = "", values = bid) + 
    facet_grid(sample~health) + 
    labs(y = "standarized regulation PEV\n", x = "") + 
    dc_bw

data %>%
  group_by(sample, bid, algorithm, health) %>%
  mutate(n.obs = n()) %>%
  ggplot(aes(as.factor(bid), dotSTD, color = algorithm)) +
    stat_summary(aes(group = algorithm), fun.y = mean, geom = "line") +
    stat_summary(fun.data = mean_cl_boot, geom = "linerange") +
    stat_summary(aes(size = n.obs), fun.y = mean, geom = "point") +
    scale_color_manual(name = "", values = algorithm) + 
    scale_size(name = "", range = c(1,4)) + 
    facet_grid(sample~health) + 
    labs(x = "\nbid value", y = "standardized regulation PEV\n") + 
    dc_bw
```

## bid value and health
```{r}
data %>%
  filter(!is.na(bid)) %>%
  group_by(bid, algorithm, health) %>%
  mutate(n.obs = n()) %>%
  ggplot(aes(as.factor(bid), dotSTD, color = health)) +
    stat_summary(aes(group = health), fun.y = mean, geom = "line") +
    stat_summary(fun.data = mean_cl_boot, geom = "linerange") +
    stat_summary(aes(size = n.obs), fun.y = mean, geom = "point") +
    scale_color_manual(name = "", values = food) + 
    scale_size(name = "", range = c(1,4)) + 
    facet_grid(sample~algorithm) + 
    labs(x = "\nbid value", y = "standardized regulation PEV\n") + 
    dc_bw
```

## bid high v. low
### all items
```{r}
data %>%
  mutate(bid.bin = ifelse(sample == "near validation" & bid > 1, "high", 
                   ifelse(sample == "near validation" & bid < 1, "low",
                   ifelse(sample == "far validation" & bid >= 1, "high",
                   ifelse(sample == "far validation" & bid < 1, "low", NA))))) %>%  
  filter(!is.na(bid.bin)) %>%
  ggplot(aes(bid.bin, dotSTD)) +
    stat_summary(aes(group = subjectID), fun.y = mean, geom = "line", alpha = .1, size = .5) +
    stat_summary(aes(group = 1), fun.y = mean, geom = "line", size = .75) +
    stat_summary(aes(color = bid.bin), fun.data = mean_cl_boot, geom = "pointrange", width = 0) + 
    facet_grid(sample~algorithm) +
    scale_color_manual(name = "", values = liking) + 
    coord_cartesian(ylim = c(-1, 1.25)) + 
    labs(y = "standarized regulation PEV\n", x = "") + 
    dc_bw

data %>%
  mutate(bid.bin = ifelse(sample == "near validation" & bid > 1, "high", 
                   ifelse(sample == "near validation" & bid < 1, "low",
                   ifelse(sample == "far validation" & bid >= 1, "high",
                   ifelse(sample == "far validation" & bid < 1, "low", NA))))) %>%
  filter(!is.na(bid.bin)) %>%
  ggplot(aes(bid.bin, dotSTD)) +
    stat_summary(aes(group = interaction(subjectID, health), color = health), fun.y = mean, geom = "line", alpha = .1, size = .5) +
    stat_summary(aes(group = health, color = health), fun.y = mean, geom = "line", size = .75) +
    stat_summary(aes(color = health), fun.data = mean_cl_boot, geom = "pointrange", width = 0) + 
    facet_grid(sample~algorithm) +
    scale_color_manual(name = "", values = food) + 
    coord_cartesian(ylim = c(-1.25, 1.25)) + 
    labs(y = "standarized regulation PEV\n", x = "") + 
    dc_bw
```

### liked items only in validation sample
```{r}
data %>%
  filter(sample == "far validation") %>%
  filter(liking == "liked") %>%
  mutate(bid.bin = ifelse(bid >= 1, "high", "low")) %>%
  ggplot(aes(bid.bin, dotSTD)) +
    stat_summary(aes(group = subjectID), fun.y = mean, geom = "line", alpha = .1, size = .5) +
    stat_summary(aes(group = 1), fun.y = mean, geom = "line", size = .75) +
    stat_summary(aes(color = bid.bin), fun.data = mean_cl_boot, geom = "pointrange", width = 0) + 
    facet_grid(~algorithm) +
    scale_color_manual(name = "", values = liking) + 
    coord_cartesian(ylim = c(-1.5, 1.5)) + 
    labs(y = "standarized regulation PEV\n", x = "") + 
    dc_bw

data %>%
  filter(sample == "far validation") %>%
  filter(liking == "liked") %>%
  mutate(bid.bin = ifelse(bid >= 1, "high", "low")) %>%
  filter(!is.na(bid.bin)) %>%
  ggplot(aes(bid.bin, dotSTD)) +
    stat_summary(aes(group = interaction(subjectID, health), color = health), fun.y = mean, geom = "line", alpha = .1, size = .5) +
    stat_summary(aes(group = health, color = health), fun.y = mean, geom = "line", size = .75) +
    stat_summary(aes(color = health), fun.data = mean_cl_boot, geom = "pointrange", width = 0) + 
    facet_grid(~algorithm) +
    scale_color_manual(name = "", values = food) + 
    coord_cartesian(ylim = c(-1.5, 1.5)) + 
    labs(y = "standarized regulation PEV\n", x = "") + 
    dc_bw
```

## bid combined
```{r, fig.width=15.5, fig.height=9}
a = data %>%
  group_by(sample, bid, algorithm) %>%
  mutate(n.obs = n()) %>%
  ggplot(aes(as.factor(bid), dotSTD, color = algorithm)) +
    stat_summary(aes(group = algorithm), fun.y = mean, geom = "line") +
    stat_summary(fun.data = mean_cl_boot, geom = "linerange") +
    stat_summary(aes(size = n.obs), fun.y = mean, geom = "point") +
    scale_color_manual(name = "", values = algorithm) + 
    scale_size(name = "", range = c(.5,3), breaks = c(600, 900, 1200)) + 
    facet_grid(sample~., scales = "free_x") + 
    labs(x = "\nbid value", y = "standardized regulation PEV\n") + 
    dc_bw +
    theme(legend.position = "top",
          legend.box = "vertical")

b = data %>%
  mutate(bid.bin = ifelse(sample == "near validation" & bid > 1, "high", 
                   ifelse(sample == "near validation" & bid < 1, "low",
                   ifelse(sample == "far validation" & bid >= 1, "high",
                   ifelse(sample == "far validation" & bid < 1, "low", NA)))),
         bid.bin = factor(bid.bin, levels = c("low", "high"))) %>%
  filter(!is.na(bid.bin)) %>%
  ggplot(aes(bid.bin, dotSTD)) +
    stat_summary(aes(group = subjectID), fun.y = mean, geom = "line", alpha = .1, size = .5) +
    stat_summary(aes(group = 1), fun.y = mean, geom = "line", size = .75) +
    stat_summary(aes(color = bid.bin), fun.data = mean_cl_boot, geom = "pointrange", width = 0) + 
    facet_grid(sample~algorithm) +
    scale_color_manual(name = "", values = liking) + 
    scale_y_continuous(breaks = scales::pretty_breaks(3)) +
    coord_cartesian(ylim = c(-1.2, 1.2)) + 
    labs(y = "standardized regulation PEV\n", x = "") + 
    dc_bw +
    theme(legend.position = "none")

c = data %>%
  mutate(bid.bin = ifelse(sample == "near validation" & bid > 1, "high", 
                   ifelse(sample == "near validation" & bid < 1, "low",
                   ifelse(sample == "far validation" & bid >= 1, "high",
                   ifelse(sample == "far validation" & bid < 1, "low", NA)))),
         bid.bin = factor(bid.bin, levels = c("low", "high"))) %>%
  filter(!is.na(bid.bin)) %>%
  ggplot(aes(bid.bin, dotSTD)) +
    stat_summary(aes(group = interaction(subjectID, health), color = health), fun.y = mean, geom = "line", alpha = .1, size = .5) +
    stat_summary(aes(group = health, color = health), fun.y = mean, geom = "line", size = .75) +
    stat_summary(aes(color = health), fun.data = mean_cl_boot, geom = "pointrange", width = 0) + 
    facet_grid(sample~algorithm) +
    scale_color_manual(name = "", values = food) + 
    scale_y_continuous(breaks = scales::pretty_breaks(3)) +
    coord_cartesian(ylim = c(-1.2, 1.2)) + 
    labs(y = "standardized regulation PEV\n", x = "") + 
    dc_bw +
    theme(legend.position = c(.9, .15))

d = data %>%
  filter(sample == "far validation") %>%
  filter(liking == "liked") %>%
  mutate(bid.bin = ifelse(bid >= 1, "high", "low"),
         bid.bin = factor(bid.bin, levels = c("low", "high"))) %>%
  ggplot(aes(bid.bin, dotSTD)) +
    stat_summary(aes(group = subjectID), fun.y = mean, geom = "line", alpha = .1, size = .5) +
    stat_summary(aes(group = 1), fun.y = mean, geom = "line", size = .75) +
    stat_summary(aes(color = bid.bin), fun.data = mean_cl_boot, geom = "pointrange", width = 0) + 
    facet_grid(sample~algorithm) +
    scale_color_manual(name = "", values = liking) + 
    scale_y_continuous(breaks = scales::pretty_breaks(3)) +
    coord_cartesian(ylim = c(-1.2, 1.2)) + 
    labs(y = "standardized regulation PEV\n", x = "") + 
    dc_bw +
    theme(legend.position = "none")

e = data %>%
  filter(sample == "far validation") %>%
  filter(liking == "liked") %>%
  mutate(bid.bin = ifelse(bid >= 1, "high", "low"),
         bid.bin = factor(bid.bin, levels = c("low", "high"))) %>%
  ggplot(aes(bid.bin, dotSTD)) +
    stat_summary(aes(group = interaction(subjectID, health), color = health), fun.y = mean, geom = "line", alpha = .1, size = .5) +
    stat_summary(aes(group = health, color = health), fun.y = mean, geom = "line", size = .75) +
    stat_summary(aes(color = health), fun.data = mean_cl_boot, geom = "pointrange", width = 0) + 
    facet_grid(sample~algorithm) +
    scale_color_manual(name = "", values = food) + 
    scale_y_continuous(breaks = scales::pretty_breaks(3)) +
    coord_cartesian(ylim = c(-1.2, 1.2)) + 
    labs(y = "standardized regulation PEV\n", x = "") + 
    dc_bw +
    theme(legend.position = c(.9, .15))

middle_row = plot_grid(b, d, labels = c('B', 'D'), ncol = 1, rel_widths = c(1, 1))
bottom_row = plot_grid(c, e, labels = c('C', 'E'), ncol = 1, rel_widths = c(1, 1))
plot_grid(a, middle_row, bottom_row, labels = c('A', '', ''), ncol = 3, rel_widths = c(1, 1, 1))
```

# individual diffs
### all items
```{r}
data %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE)) %>%
  ggplot(aes(health, meanPEV, color = health)) + 
    geom_boxplot() +
    facet_grid(algorithm~sample, scales = "free_y") +
    scale_color_manual(values = food) +
    labs(y = "mean standardized regulation PEV\n") +
    dc_bw

data %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE)) %>%
  select(sample, subjectID, algorithm, meanPEV, meanBid, health) %>%
  unique() %>%
  ggplot(aes(meanPEV, meanBid, color = health)) + 
    geom_point(alpha = .4) +
    geom_smooth(method = "lm", alpha = .2) +
    facet_grid(sample~algorithm, scales = "free_x") +
    scale_color_manual(values = food) +
    labs(x = "\nmean standardized regulation PEV", y = "mean bid value\n") +
    dc_bw

data %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         health1 = health) %>%
  select(sample, subjectID, algorithm, meanPEV, meanBid, health, health1) %>%
  unique() %>%
  spread(health, meanBid) %>%
  group_by(subjectID, algorithm) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(pref.health = healthy - unhealthy) %>%
  spread(health1, meanPEV) %>%
  mutate(diff = unhealthy - healthy) %>%
  ggplot(aes(diff, pref.health)) + 
    geom_point() +
    geom_smooth(method = "lm", se = .1) +
    facet_grid(sample~algorithm, scales = "free_x") +
    labs(x = "\ndifference in mean regulation PEV (unhealthy - healthy)", y = "difference in mean bid value (healthy - unhealthy)") + 
    dc_bw

data %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         health1 = health) %>%
  select(sample, subjectID, algorithm, meanPEV, meanBid, health, health1) %>%
  unique() %>%
  spread(health, meanBid) %>%
  group_by(subjectID, algorithm) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(pref.health = healthy - unhealthy) %>%
  spread(health1, meanPEV) %>%
  mutate(diff = unhealthy - healthy) %>% 
  ungroup() %>%
  nest(-c(sample, algorithm)) %>% 
  mutate(
    test = map(data, ~ cor.test(.x$pref.health, .x$diff)),
    tidied = map(test, broom::tidy)
  ) %>% 
  unnest(tidied, .drop = TRUE)
```

### liked items only in validation sample
```{r}
data %>%
  filter(sample == "far validation") %>%
  filter(liking == "liked") %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE)) %>%
  ggplot(aes(health, meanPEV, color = health)) + 
    geom_boxplot() +
    facet_wrap(~algorithm, scales = "free", ncol = 4) +
    scale_color_manual(values = food) +
    labs(y = "mean standardized regulation PEV\n") +
    dc_bw

data %>%
  filter(sample == "far validation") %>%
  filter(liking == "liked") %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE)) %>%
  select(subjectID, algorithm, meanPEV, meanBid, health) %>%
  unique() %>%
  ggplot(aes(meanPEV, meanBid, color = health)) + 
    geom_point(alpha = .4) +
    geom_smooth(method = "lm", alpha = .2) +
    facet_wrap(~algorithm, scales = "free", ncol = 4) +
    scale_color_manual(values = food) +
    labs(x = "\nmean standardized regulation PEV", y = "mean bid value\n") +
    dc_bw

data %>%
  filter(sample == "far validation") %>%
  filter(liking == "liked") %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         health1 = health) %>%
  select(subjectID, algorithm, meanPEV, meanBid, health, health1) %>%
  unique() %>%
  spread(health, meanBid) %>%
  group_by(subjectID, algorithm) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(pref.health = healthy - unhealthy) %>%
  spread(health1, meanPEV) %>%
  mutate(diff = unhealthy - healthy) %>%
  ggplot(aes(diff, pref.health)) + 
    geom_point() +
    geom_smooth(method = "lm", se = .1) +
    facet_wrap(~algorithm, scales = "free", ncol = 4) +
    labs(x = "\ndifference in mean regulation PEV (unhealthy - healthy)", y = "difference in mean bid value (healthy - unhealthy)") + 
    dc_bw

data %>%
  filter(sample == "far validation") %>%
  filter(liking == "liked") %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         health1 = health) %>%
  select(subjectID, algorithm, meanPEV, meanBid, health, health1) %>%
  unique() %>%
  spread(health, meanBid) %>%
  group_by(subjectID, algorithm) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(pref.health = healthy - unhealthy) %>%
  spread(health1, meanPEV) %>%
  mutate(diff = unhealthy - healthy) %>% 
  ungroup() %>%
  nest(-algorithm) %>% 
  mutate(
    test = map(data, ~ cor.test(.x$pref.health, .x$diff)),
    tidied = map(test, broom::tidy)
  ) %>% 
  unnest(tidied, .drop = TRUE)
```

### combined
```{r, fig.width=6, fig.height=7}
ind.liked = data %>%
  filter(sample == "far validation") %>%
  filter(liking == "liked") %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         sample = "far validation liked only") %>%
  select(sample, subjectID, algorithm, meanPEV, meanBid, health) %>%
  unique()

(plot.PEV = data %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE)) %>%
  select(sample, subjectID, algorithm, meanPEV, meanBid, health) %>%
  unique() %>%
  bind_rows(ind.liked) %>%
  mutate(sample = factor(sample, levels = c("near validation", "far validation", "far validation liked only"))) %>%
  ggplot(aes(meanPEV, meanBid, color = health)) + 
    geom_point(alpha = .2) +
    geom_smooth(method = "lm", alpha = .2) +
    facet_grid(sample~algorithm, scales = "free_x") +
    scale_color_manual(name = "", values = food) +
    scale_y_continuous(breaks = scales::pretty_breaks(3)) +
    scale_x_continuous(breaks = scales::pretty_breaks(3)) +
    labs(x = "\nmean standardized regulation PEV", y = "mean bid value\n") +
    dc_bw +
    theme(legend.position = "top",
          legend.box = "vertical"))
```

## percent
### all items
```{r}
outliers = data %>%
  filter((subjectID == "CHIVES1021" & algorithm == "regulate > rest" & health == "healthy") | 
         (subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy")) %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         percentReg = (sumReg / n) * 100) %>%
  select(sample, subjectID, algorithm, meanPEV, meanBid, percentReg, health) %>%
  unique() 

data %>%
  filter(!((subjectID == "CHIVES1021" & algorithm == "regulate > rest" & health == "healthy") |
         (subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy"))) %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         percentReg = (sumReg / n) * 100) %>%
  select(sample, subjectID, algorithm, meanPEV, meanBid, percentReg, health) %>%
  unique() %>%
  ggplot(aes(percentReg, meanBid, color = health)) + 
    geom_point(alpha = .4) +
    geom_point(data = outliers, color = "black") +
    geom_smooth(method = "lm", alpha = .2) +
    facet_wrap(sample~algorithm, scales = "free") +
    scale_color_manual(values = food) +
    labs(x = "\npercent regulation", y = "mean bid value\n") +
    dc_bw

data %>%
  filter(!((subjectID == "CHIVES1021" & algorithm == "regulate > rest" & health == "healthy") |
         (subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy"))) %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         percentReg = (sumReg / n) * 100) %>%
  select(sample, subjectID, algorithm, meanPEV, meanBid, percentReg, health) %>%
  unique() %>%
  ggplot(aes(percentReg, meanPEV, color = health)) + 
    geom_point(alpha = .4) +
    geom_point(data = outliers, color = "black") +
    geom_smooth(method = "lm", alpha = .2) +
    facet_wrap(sample~algorithm, scales = "free") +
    scale_color_manual(values = food) +
    labs(x = "\npercent regulation", y = "mean standardized regulation pattern expression value\n") +
    dc_bw

data %>%
  filter(!((subjectID == "CHIVES1021" & algorithm == "regulate > rest" & health == "healthy") |
         (subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy"))) %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         percentReg = (sumReg / n) * 100,
         health1 = health,
         health2 = health) %>%
  select(sample, subjectID, algorithm, meanPEV, meanBid, percentReg, health, health1, health2) %>%
  unique() %>%
  spread(health, meanBid) %>%
  group_by(subjectID, algorithm) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(pref.health = healthy - unhealthy) %>%
  spread(health1, meanPEV) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(diff = unhealthy - healthy) %>%
  spread(health2, percentReg) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(diffReg = unhealthy - healthy) %>%
  unique() %>%
  ggplot(aes(diffReg, pref.health)) + 
    geom_point() +
    geom_smooth(method = "lm", alpha = .2) +
    facet_wrap(sample~algorithm, scales = "free") +
    labs(x = "\ndifference percent regulation (unhealthy - healthy)", y = "difference in mean bid value (healthy - unhealthy)") + 
    dc_bw

data %>%
  filter(!((subjectID == "CHIVES1021" & algorithm == "regulate > rest" & health == "healthy") |
         (subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy"))) %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         percentReg = (sumReg / n) * 100,
         health1 = health,
         health2 = health) %>%
  select(sample, subjectID, algorithm, meanPEV, meanBid, percentReg, health, health1, health2) %>%
  unique() %>%
  spread(health, meanBid) %>%
  group_by(subjectID, algorithm) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(pref.health = healthy - unhealthy) %>%
  spread(health1, meanPEV) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(diff = unhealthy - healthy) %>%
  spread(health2, percentReg) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(diffReg = unhealthy - healthy) %>%
  ungroup() %>%
  nest(-c(sample, algorithm)) %>% 
  mutate(
    test = map(data, ~ cor.test(.x$pref.health, .x$diffReg)),
    tidied = map(test, broom::tidy)
  ) %>% 
  unnest(tidied, .drop = TRUE)

data %>%
  filter(!((subjectID == "CHIVES1021" & algorithm == "regulate > rest" & health == "healthy") |
         (subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy"))) %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         percentReg = (sumReg / n) * 100,
         health1 = health,
         health2 = health) %>%
  select(sample, subjectID, algorithm, meanPEV, meanBid, percentReg, health, health1, health2) %>%
  unique() %>%
  spread(health, meanBid) %>%
  group_by(subjectID, algorithm) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(pref.health = healthy - unhealthy) %>%
  spread(health1, meanPEV) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(diff = unhealthy - healthy) %>%
  spread(health2, percentReg) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(diffReg = unhealthy - healthy) %>%
  unique() %>%
  ggplot(aes(diffReg, diff)) + 
    geom_point() +
    geom_smooth(method = "lm", se = .1) +
    facet_wrap(~algorithm, scales = "free", ncol = 4) +
    labs(x = "\ndifference percent regulation (unhealthy - healthy)", y = "difference in mean regulation PEV (unhealthy - healthy") + 
    dc_bw

data %>%
  filter(!((subjectID == "CHIVES1021" & algorithm == "regulate > rest" & health == "healthy") |
         (subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy"))) %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         percentReg = (sumReg / n) * 100,
         health1 = health,
         health2 = health) %>%
  select(sample, subjectID, algorithm, meanPEV, meanBid, percentReg, health, health1, health2) %>%
  unique() %>%
  spread(health, meanBid) %>%
  group_by(subjectID, algorithm) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(pref.health = healthy - unhealthy) %>%
  spread(health1, meanPEV) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(diff = unhealthy - healthy) %>%
  spread(health2, percentReg) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(diffReg = unhealthy - healthy) %>%
  ungroup() %>%
  nest(-c(sample, algorithm)) %>% 
  mutate(
    test = map(data, ~ cor.test(.x$diff, .x$diffReg)),
    tidied = map(test, broom::tidy)
  ) %>% 
  unnest(tidied, .drop = TRUE)
```

### combined
```{r, fig.width=6, fig.height=7}
ind.liked = data %>%
  filter(!(subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy")) %>%
  filter(sample == "far validation") %>%
  filter(liking == "liked") %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         percentReg = (sumReg / n) * 100,
         sample = "far validation liked only") %>%
  select(sample, subjectID, algorithm, meanPEV, meanBid, percentReg, health) %>%
  unique()
  
(plot.percent = data %>%
  filter(!((subjectID == "CHIVES1021" & algorithm == "regulate > rest" & health == "healthy") |
         (subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy"))) %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         percentReg = (sumReg / n) * 100) %>%
  select(sample, subjectID, algorithm, meanPEV, meanBid, percentReg, health) %>%
  unique() %>%
  bind_rows(ind.liked) %>%
  mutate(sample = factor(sample, levels = c("near validation", "far validation", "far validation liked only"))) %>%
  ggplot(aes(percentReg, meanBid, color = health)) + 
    geom_point(alpha = .2) +
    geom_point(data = outliers, color = "black", alpha = .4) +
    geom_smooth(method = "lm", alpha = .2) +
    facet_grid(sample~algorithm, scales = "free_x") +
    scale_color_manual(name = "", values = food) +
    scale_y_continuous(breaks = scales::pretty_breaks(3)) +
    scale_x_continuous(breaks = scales::pretty_breaks(3)) +
    labs(x = "\npercent regulation (PEV > 0)", y = "mean bid value\n") +
    dc_bw +
    theme(legend.position = "top",
          legend.box = "vertical"))
```

### combined mean PEV and percent regulation
```{r, fig.width=12, fig.height=7}
plot_grid(plot.PEV, plot.percent, ncol = 2, labels = c('A', 'B'))
```

### liked items only in validation sample
```{r}
outliers.val = data %>%
  filter(subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy") %>%
  filter(sample == "far validation") %>%
  filter(liking == "liked") %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         percentReg = (sumReg / n) * 100) %>%
  select(sample, subjectID, algorithm, meanPEV, meanBid, percentReg, health) %>%
  unique()

data %>%
  filter(!(subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy")) %>%
  filter(sample == "far validation") %>%
  filter(liking == "liked") %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         percentReg = (sumReg / n) * 100) %>%
  select(subjectID, algorithm, meanPEV, meanBid, percentReg, health) %>%
  unique() %>%
  ggplot(aes(percentReg, meanBid, color = health)) + 
    geom_point(alpha = .4) +
    geom_point(data = outliers.val, color = "black") +
    geom_smooth(method = "lm", alpha = .2) +
    facet_wrap(~algorithm, scales = "free", ncol = 4) +
    scale_color_manual(values = food) +
    labs(x = "\npercent regulation", y = "mean bid value\n") +
    dc_bw

data %>%
  filter(!(subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy")) %>%
  filter(sample == "far validation") %>%
  filter(liking == "liked") %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         percentReg = (sumReg / n) * 100) %>%
  select(subjectID, algorithm, meanPEV, meanBid, percentReg, health) %>%
  unique() %>%
  ggplot(aes(percentReg, meanPEV, color = health)) + 
    geom_point(alpha = .4) +
    geom_point(data = outliers.val, color = "black") +
    geom_smooth(method = "lm", alpha = .2) +
    facet_wrap(~algorithm, scales = "free", ncol = 4) +
    scale_color_manual(values = food) +
    labs(x = "\npercent regulation", y = "mean standardized regulation pattern expression value\n") +
    dc_bw

data %>%
  filter(!(subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy")) %>%
  filter(sample == "far validation") %>%
  filter(liking == "liked") %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         percentReg = (sumReg / n) * 100,
         health1 = health,
         health2 = health) %>%
  select(subjectID, algorithm, meanPEV, meanBid, percentReg, health, health1, health2) %>%
  unique() %>%
  spread(health, meanBid) %>%
  group_by(subjectID, algorithm) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(pref.health = healthy - unhealthy) %>%
  spread(health1, meanPEV) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(diff = unhealthy - healthy) %>%
  spread(health2, percentReg) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(diffReg = unhealthy - healthy) %>%
  unique() %>%
  ggplot(aes(diffReg, pref.health)) + 
    geom_point() +
    geom_smooth(method = "lm", se = .1) +
    facet_wrap(~algorithm, scales = "free", ncol = 4) +
    labs(x = "\ndifference percent regulation (unhealthy - healthy)", y = "difference in mean bid value (healthy - unhealthy)") + 
    dc_bw

data %>%
  filter(!(subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy")) %>%
  filter(sample == "far validation") %>%
  filter(liking == "liked") %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         percentReg = (sumReg / n) * 100,
         health1 = health,
         health2 = health) %>%
  select(subjectID, algorithm, meanPEV, meanBid, percentReg, health, health1, health2) %>%
  unique() %>%
  spread(health, meanBid) %>%
  group_by(subjectID, algorithm) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(pref.health = healthy - unhealthy) %>%
  spread(health1, meanPEV) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(diff = unhealthy - healthy) %>%
  spread(health2, percentReg) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(diffReg = unhealthy - healthy) %>%
  ungroup() %>%
  nest(-algorithm) %>% 
  mutate(
    test = map(data, ~ cor.test(.x$pref.health, .x$diffReg)),
    tidied = map(test, broom::tidy)
  ) %>% 
  unnest(tidied, .drop = TRUE)

data %>%
  filter(!(subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy")) %>%
  filter(sample == "far validation") %>%
  filter(liking == "liked") %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         percentReg = (sumReg / n) * 100,
         health1 = health,
         health2 = health) %>%
  select(subjectID, algorithm, meanPEV, meanBid, percentReg, health, health1, health2) %>%
  unique() %>%
  spread(health, meanBid) %>%
  group_by(subjectID, algorithm) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(pref.health = healthy - unhealthy) %>%
  spread(health1, meanPEV) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(diff = unhealthy - healthy) %>%
  spread(health2, percentReg) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(diffReg = unhealthy - healthy) %>%
  unique() %>%
  ggplot(aes(diffReg, diff)) + 
    geom_point() +
    geom_smooth(method = "lm", se = .1) +
    facet_wrap(~algorithm, scales = "free", ncol = 4) +
    labs(x = "\ndifference percent regulation (unhealthy - healthy)", y = "difference in mean regulation PEV (unhealthy - healthy") + 
    dc_bw

data %>%
  filter(!(subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy")) %>%
  filter(sample == "far validation") %>%
  filter(liking == "liked") %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         percentReg = (sumReg / n) * 100,
         health1 = health,
         health2 = health) %>%
  select(subjectID, algorithm, meanPEV, meanBid, percentReg, health, health1, health2) %>%
  unique() %>%
  spread(health, meanBid) %>%
  group_by(subjectID, algorithm) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(pref.health = healthy - unhealthy) %>%
  spread(health1, meanPEV) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(diff = unhealthy - healthy) %>%
  spread(health2, percentReg) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(diffReg = unhealthy - healthy) %>%
  ungroup() %>%
  nest(-algorithm) %>% 
  mutate(
    test = map(data, ~ cor.test(.x$diff, .x$diffReg)),
    tidied = map(test, broom::tidy)
  ) %>% 
  unnest(tidied, .drop = TRUE)
```

# correlations
## all items
```{r, fig.width=9.5, fig.height=7}
cors = data %>%
filter(!((subjectID == "CHIVES1021" & algorithm == "regulate > rest" & health == "healthy") |
         (subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy"))) %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         percentReg = (sumReg / n) * 100) %>%
  gather(variable, value, meanPEV, meanBid, percentReg) %>%
  select(sample, subjectID, health, algorithm, variable, value) %>%
  unique() %>%
  unite("health", c("variable", "health")) %>%
  ungroup() %>%
  select(sample, subjectID, algorithm, health, value) %>%
  group_by(sample, algorithm) %>%
  do({
    health.spread = spread(., health, value)
    cors = cor(health.spread[,-c(1:3)], use = "pairwise.complete.obs") %>%
      as.data.frame() %>%
      mutate(algorithm = health.spread$algorithm[[1]],
             sample = health.spread$sample[[1]],
             health = colnames(health.spread)[-c(1:3)])
  })

cors %>%
  reshape2::melt() %>%
  ggplot(aes(health, variable, fill = value)) +
    geom_tile(color = "white") +
    scale_fill_gradientn(name = "correlation\n", colors = c("#3B9AB2", "white", "#F21A00"), limits = c(-1, 1), breaks = c(-1, 0, 1)) + 
    geom_text(aes(label = round(value, 2)), size = 3, family = "Futura Medium") +
    facet_wrap(sample~algorithm) +
    labs(x = "", y = "") + 
    dc_bw +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

## liked items only in validation sample
```{r, fig.width=9.5, fig.height=4}
cors = data %>%
filter(!(subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy")) %>%
  filter(sample == "far validation") %>%
  filter(liking == "liked") %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         percentReg = (sumReg / n) * 100) %>%
  gather(variable, value, meanPEV, meanBid, percentReg) %>%
  select(sample, subjectID, health, algorithm, variable, value) %>%
  unique() %>%
  unite("health", c("variable", "health")) %>%
  ungroup() %>%
  select(subjectID, algorithm, health, value) %>%
  group_by(algorithm) %>%
  do({
    health.spread = spread(., health, value)
    cors = cor(health.spread[,-c(1:2)], use = "pairwise.complete.obs") %>%
      as.data.frame() %>%
      mutate(algorithm = health.spread$algorithm[[1]],
             health = colnames(health.spread)[-c(1:2)])
  })

cors %>%
  reshape2::melt() %>%
  ggplot(aes(health, variable, fill = value)) +
    geom_tile(color = "white") +
    scale_fill_gradientn(name = "correlation\n", colors = c("#3B9AB2", "white", "#F21A00"), limits = c(-1, 1), breaks = c(-1, 0, 1)) + 
    geom_text(aes(label = round(value, 2)), size = 3, family = "Futura Medium") +
    facet_wrap(~algorithm) +
    labs(x = "", y = "") + 
    dc_bw +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

## unhealthy items only
```{r, fig.width=6.5, fig.height=4.5}
cors = data %>%
filter(!((subjectID == "CHIVES1021" & algorithm == "regulate > rest" & health == "healthy") |
         (subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy"))) %>%
  filter(health == "unhealthy") %>%
  group_by(subjectID, algorithm) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         percentReg = (sumReg / n) * 100) %>%
  gather(variable, value, meanPEV, meanBid, percentReg) %>%
  select(sample, subjectID, health, algorithm, variable, value) %>%
  unique() %>%
  ungroup() %>%
  select(sample, subjectID, algorithm, variable, value) %>%
  group_by(sample, algorithm) %>%
  do({
    health.spread = spread(., variable, value)
    cors = cor(health.spread[,-c(1:3)], use = "pairwise.complete.obs", method = "pearson") %>%
      as.data.frame() %>%
      mutate(algorithm = health.spread$algorithm[[1]],
             sample = health.spread$sample[[1]],
             health = colnames(health.spread)[-c(1:3)])
  })


cors %>%
  reshape2::melt() %>%
  ggplot(aes(health, variable, fill = value)) +
    geom_tile(color = "white") +
    scale_fill_gradientn(name = "correlation\n", colors = c("#3B9AB2", "white", "#F21A00"), limits = c(-1, 1), breaks = c(-1, 0, 1)) + 
    geom_text(aes(label = round(value, 2)), size = 3, family = "Futura Medium") +
    facet_wrap(sample~algorithm) +
    labs(x = "", y = "") + 
    dc_bw +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

## liked unhealthy items only in validation sample
```{r, fig.width=6, fig.height=2.5}
cors = data %>%
filter(!(subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy")) %>%
  filter(sample == "far validation") %>%
  filter(liking == "liked" & health == "unhealthy") %>%
  group_by(subjectID, algorithm) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         percentReg = (sumReg / n) * 100) %>%
  gather(variable, value, meanPEV, meanBid, percentReg) %>%
  select(sample, subjectID, health, algorithm, variable, value) %>%
  unique() %>%
  ungroup() %>%
  select(subjectID, algorithm, variable, value) %>%
  group_by(algorithm) %>%
  do({
    health.spread = spread(., variable, value)
    cors = cor(health.spread[,-c(1:2)], use = "pairwise.complete.obs", method = "pearson") %>%
      as.data.frame() %>%
      mutate(algorithm = health.spread$algorithm[[1]],
             health = colnames(health.spread)[-c(1:2)])
  })

cors %>%
  reshape2::melt() %>%
  ggplot(aes(health, variable, fill = value)) +
    geom_tile(color = "white") +
    scale_fill_gradientn(name = "correlation\n", colors = c("#3B9AB2", "white", "#F21A00"), limits = c(-1, 1), breaks = c(-1, 0, 1)) + 
    geom_text(aes(label = round(value, 2)), size = 3, family = "Futura Medium") +
    facet_wrap(~algorithm) +
    labs(x = "", y = "") + 
    dc_bw +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

data %>%
filter(!(subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy")) %>%
  filter(sample == "far validation") %>%
  filter(health == "unhealthy" & liking == "liked") %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE)) %>%
  select(subjectID, algorithm, meanPEV, meanBid) %>%
  unique() %>% 
  ungroup() %>%
  nest(-algorithm) %>% 
  mutate(
    test = map(data, ~ cor.test(.x$meanBid, .x$meanPEV)),
    tidied = map(test, broom::tidy)
  ) %>% 
  unnest(tidied, .drop = TRUE)
```

## combined
```{r, fig.width=14, fig.height=13}
cors.diffs = data %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(meanPEV = mean(dotSTD, na.rm = TRUE),
         meanBid = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         percentReg = (sumReg / n) * 100,
         health1 = health,
         health2 = health) %>%
  select(subjectID, algorithm, meanPEV, meanBid, percentReg, health, health1, health2) %>%
  unique() %>%
  spread(health, meanBid) %>%
  group_by(subjectID, algorithm) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(pref.health = healthy - unhealthy) %>%
  spread(health1, meanPEV) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(diff = unhealthy - healthy) %>%
  spread(health2, percentReg) %>%
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>%
  mutate(diffReg = unhealthy - healthy)

cors.all = data %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(`mean PEV` = mean(dotSTD, na.rm = TRUE),
         `mean bid` = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         `percent regulation` = (sumReg / n) * 100) %>%
  left_join(., cors.diffs) %>%
  gather(variable, value, `mean PEV`, `mean bid`, `percent regulation`, pref.health,  diff) %>%
  select(sample, subjectID, health, algorithm, variable, value) %>%
  unique() %>%
  filter(!((subjectID == "CHIVES1021" & algorithm == "regulate > rest" & health == "healthy" & variable == "percent regulation") |
         (subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy" & variable == "percent regulation"))) %>%
  unite("health", c("variable", "health"), sep = " ") %>%
  filter(!health %in% c("pref.health healthy", "diff healthy")) %>%
  mutate(health = ifelse(health == "pref.health unhealthy", "bid difference\n(healthy - unhealthy)",
                       ifelse(health == "diff unhealthy", "PEV difference\n(unhealthy - healthy)", health))) %>%
  ungroup() %>%
  select(sample, subjectID, algorithm, health, value) %>%
  group_by(sample, algorithm) %>%
  do({
    health.spread = spread(., health, value)
    cors = cor(health.spread[,-c(1:3)], use = "pairwise.complete.obs") %>%
      as.data.frame() %>%
      mutate(algorithm = health.spread$algorithm[[1]],
             sample = health.spread$sample[[1]],
             health = colnames(health.spread)[-c(1:3)])
  })

cors.liked = data %>%
  filter(sample == "far validation") %>%
  filter(liking == "liked") %>%
  group_by(subjectID, algorithm, health) %>%
  mutate(`mean PEV` = mean(dotSTD, na.rm = TRUE),
         `mean bid` = mean(bid, na.rm = TRUE),
         regulation = ifelse(dotSTD > 0, 1, 0),
         sumReg = sum(regulation, na.rm = TRUE),
         n = n(), 
         `percent regulation` = (sumReg / n) * 100) %>%
  left_join(., cors.diffs) %>%
  gather(variable, value, `mean PEV`, `mean bid`, `percent regulation`, pref.health,  diff) %>%
  select(sample, subjectID, health, algorithm, variable, value) %>%
  unique() %>%
  filter(!(subjectID == "DEV037" & algorithm == "regulate > rest" & health == "healthy" & variable == "percent regulation")) %>%
  unite("health", c("variable", "health"), sep = " ") %>%
  filter(!health %in% c("pref.health healthy", "diff healthy")) %>%
  mutate(health = ifelse(health == "pref.health unhealthy", "bid difference\n(healthy - unhealthy)",
                       ifelse(health == "diff unhealthy", "PEV difference\n(unhealthy - healthy)", health))) %>%
  ungroup() %>%
  select(sample, subjectID, algorithm, health, value) %>%
  group_by(sample, algorithm) %>%
  do({
    health.spread = spread(., health, value)
    cors = cor(health.spread[,-c(1:3)], use = "pairwise.complete.obs") %>%
      as.data.frame() %>%
      mutate(algorithm = health.spread$algorithm[[1]],
             sample = health.spread$sample[[1]],
             health = colnames(health.spread)[-c(1:3)])
  }) %>%
  ungroup() %>%
  mutate(sample = "far validation liked only")

cors.all %>%
  bind_rows(., cors.liked) %>%
  reshape2::melt() %>%
  mutate(sample = factor(sample, levels = c("near validation", "far validation", "far validation liked only")),
         order = ifelse(grepl("^bid|^PEV", variable), 3,
                 ifelse(grepl("mean", variable), 1,
                 ifelse(grepl("percent", variable), 2, NA))),
         orderHealth = ifelse(grepl("^bid|^PEV", health), 3,
                       ifelse(grepl("mean", health), 1, 
                       ifelse(grepl("percent", health), 2, NA)))) %>%
  ggplot(aes(reorder(health, orderHealth), reorder(variable, order), fill = value)) +
    geom_tile(color = "white") +
    scale_fill_gradientn(name = "", colors = c("#3B9AB2", "white", "#F21A00"), limits = c(-1, 1), breaks = c(-1, 0, 1)) + 
    geom_text(aes(label = round(value, 2)), size = 3, family = "Futura Medium") +
    facet_grid(sample~algorithm) +
    labs(x = "", y = "") + 
    dc_bw +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
          axis.line = element_blank(),
          legend.position = "none")
```

# specification curve analysis
## development -- health
```{r}
# set na.action for dredge
options(na.action = "na.fail")

# tidy data
data.sca = data %>%
  filter(sample == "near validation") %>%
  select(subjectID, trial, algorithm, dotSTD, bid, health) %>%
  spread(algorithm, dotSTD) %>%
  na.omit()

# ICC
model.icc = anova(lm(bid ~ subjectID, data = data.sca))
model.icc$`Sum Sq`[1] / sum(model.icc$`Sum Sq`)

# run full model
models = lmer(bid ~ health*`logistic classifier` + health*`regulate > look` + health*`regulate > rest` + (1 | subjectID), data = data.sca)

# run all possible nested models
models.sca = dredge(models, rank = "AIC", extra = "BIC") %>%
  select(AIC, delta, BIC, df, logLik, weight, `(Intercept)`, health, everything())

# set AIC for null model you want to compare model AIC values to
null = models.sca %>%
  arrange(df) %>%
  filter(health == "+" & df == 4)

# tidy for plotting
plot.data = models.sca %>%
  arrange(AIC) %>%
  mutate(specification = row_number(),
         better.fit = ifelse(AIC == null$AIC, "equal",
                      ifelse(AIC < null$AIC, "yes", "no")))

# order = plot.data %>%
#   arrange(AIC) %>%
#   mutate(better.fit.num = ifelse(better.fit == "yes", 1, 0)) %>%
#   gather(variable, value, -c(AIC, delta, BIC, df, logLik, weight, better.fit.num, specification, better.fit)) %>%
#   filter(!is.na(value)) %>%
#   group_by(variable) %>%
#   mutate(order = sum(better.fit.num)) %>%
#   select(variable, order) %>%
#   unique()

order = plot.data %>%
  gather(variable, value, -c(AIC, delta, BIC, df, logLik, weight, specification, better.fit)) %>%
  mutate(order = ifelse(grepl("^health", variable), 3,
                 ifelse(grepl(":health", variable), 1, 2))) %>%
  select(variable, order) %>%
  unique()

# variables included in model
variable.names = names(select(plot.data, -starts_with("better"), -specification, -AIC, -BIC, -df, -logLik, -delta, -weight, -`(Intercept)`))

# plot top panel
a = plot.data %>%
  ggplot(aes(specification, AIC, color = better.fit)) +
    geom_point(shape = "|", size = 4, alpha = .75) +
    geom_hline(yintercept = null$AIC, linetype = "dashed", color = "#5BBCD6") +
    scale_color_manual(values = c("#5BBCD6", "black", "#F43C13")) +
    labs(x = "", y = "AIC\n") +
    dc_bw +
    theme(legend.position = "none")
    # theme(#legend.title = element_text(size = 1),
    #       #legend.text = element_text(size = 9))

# set plotting order for variables based on number of times it's included in better fitting models
b = plot.data %>%
  gather(variable, value, eval(variable.names)) %>%
  left_join(., order, by = "variable") %>%
  mutate(value = ifelse(!is.na(value), "|", ""),
         variable = gsub("`regulate > look`", "regulate > look", variable),
         variable = gsub("`regulate > rest`", "regulate > rest", variable),
         variable = gsub("`logistic classifier`", "logistic classifier", variable),
         variable = gsub("regulate > look:health", "health:regulate > look", variable),
         variable = gsub("regulate > rest:health", "health:regulate > rest", variable),
         variable = gsub("logistic classifier:health", "health:logistic classifier", variable),
         variable = gsub("health:", "health  x  ", variable),
         variable = gsub("health", "food type", variable)) %>%
  ggplot(aes(specification, reorder(variable, order), color = better.fit)) +
    geom_text(aes(label = value), alpha = .75) +
    scale_color_manual(values = c("#5BBCD6", "black", "#F43C13")) +
    labs(x = "\nspecification number", y = "variables\n") +
    dc_bw +
    theme(legend.position = "none")
    # theme(#legend.title = element_text(size = 1),
    #       #legend.text = element_text(size = 9))

(plot.dev = plot_grid(a, b, ncol = 1, align = "v"))
```

## validation -- health
```{r}
# set na.action for dredge
options(na.action = "na.fail")

# tidy data
data.sca = data %>%
  filter(sample == "far validation") %>%
  select(subjectID, trial, algorithm, dotSTD, bid, health) %>%
  spread(algorithm, dotSTD) %>%
  na.omit()

# ICC
model.icc = anova(lm(bid ~ subjectID, data = data.sca))
model.icc$`Sum Sq`[1] / sum(model.icc$`Sum Sq`)

# run full model
models = lmer(bid ~ health*`logistic classifier` + health*`regulate > look` + health*`regulate > rest` + (1 | subjectID), data = data.sca)

# run all possible nested models
models.sca = dredge(models, rank = "AIC", extra = "BIC") %>%
  select(AIC, delta, BIC, df, logLik, weight, `(Intercept)`, health, everything())

# set AIC for null model you want to compare model AIC values to
null = models.sca %>%
  arrange(df) %>%
  filter(health == "+" & df == 4)

# tidy for plotting
plot.data = models.sca %>%
  arrange(AIC) %>%
  mutate(specification = row_number(),
         better.fit = ifelse(AIC == null$AIC, "equal",
                      ifelse(AIC < null$AIC, "yes", "no")))

# order = plot.data %>%
#   arrange(AIC) %>%
#   mutate(better.fit.num = ifelse(better.fit == "yes", 1, 0)) %>%
#   gather(variable, value, -c(AIC, delta, BIC, df, logLik, weight, better.fit.num, specification, better.fit)) %>%
#   filter(!is.na(value)) %>%
#   group_by(variable) %>%
#   mutate(order = sum(better.fit.num)) %>%
#   select(variable, order) %>%
#   unique()

order = plot.data %>%
  gather(variable, value, -c(AIC, delta, BIC, df, logLik, weight, specification, better.fit)) %>%
  mutate(order = ifelse(grepl("^health", variable), 3,
                 ifelse(grepl(":health", variable), 1, 2))) %>%
  select(variable, order) %>%
  unique()

# variables included in model
variable.names = names(select(plot.data, -starts_with("better"), -specification, -AIC, -BIC, -df, -logLik, -delta, -weight, -`(Intercept)`))

# plot top panel
a = plot.data %>%
  ggplot(aes(specification, AIC, color = better.fit)) +
    geom_point(shape = "|", size = 4, alpha = .75) +
    geom_hline(yintercept = null$AIC, linetype = "dashed", color = "#5BBCD6") +
    scale_color_manual(values = c("#5BBCD6", "black", "#F43C13")) +
    labs(x = "", y = "AIC\n") +
    dc_bw +
    theme(legend.position = "none")
    # theme(#legend.title = element_text(size = 1),
    #       #legend.text = element_text(size = 9))

# set plotting order for variables based on number of times it's included in better fitting models
b = plot.data %>%
  gather(variable, value, eval(variable.names)) %>%
  left_join(., order, by = "variable") %>%
  mutate(value = ifelse(!is.na(value), "|", ""),
         variable = gsub("`regulate > look`", "regulate > look", variable),
         variable = gsub("`regulate > rest`", "regulate > rest", variable),
         variable = gsub("`logistic classifier`", "logistic classifier", variable),
         variable = gsub("regulate > look:health", "health:regulate > look", variable),
         variable = gsub("regulate > rest:health", "health:regulate > rest", variable),
         variable = gsub("logistic classifier:health", "health:logistic classifier", variable),
         variable = gsub("health:", "health  x  ", variable),
         variable = gsub("health", "food type", variable)) %>%
  ggplot(aes(specification, reorder(variable, order), color = better.fit)) +
    geom_text(aes(label = value), alpha = .75) +
    scale_color_manual(values = c("#5BBCD6", "black", "#F43C13")) +
    labs(x = "\nspecification number", y = "variables\n") +
    dc_bw +
    theme(legend.position = "none")
    # theme(#legend.title = element_text(size = 1),
    #       #legend.text = element_text(size = 9))

(plot.val = plot_grid(a, b, ncol = 1, align = "v"))
```

## health combined
```{r, fig.width = 6, fig.height = 8}
plot_grid(plot.dev, plot.val, ncol = 1, align = "v", labels = c('A', 'B'))
```

## validation -- liking and health
```{r, fig.width=8, fig.height=6}
# set na.action for dredge
options(na.action = "na.fail")

# tidy data
data.sca = data %>%
  filter(sample == "far validation") %>%
  select(subjectID, trial, algorithm, dotSTD, bid, health, liking) %>%
  spread(algorithm, dotSTD) %>%
  na.omit()

# run full model
models = lmer(bid ~ liking*`logistic classifier` + liking*`regulate > look` + liking*`regulate > rest` + health*`logistic classifier` + health*`regulate > look` + health*`regulate > rest` +(1 | subjectID), data = data.sca)

# run all possible nested models
models.sca = dredge(models, rank = "AIC", extra = "BIC") %>%
  select(AIC, delta, BIC, df, logLik, weight, `(Intercept)`, liking, everything())

# set AIC for null model you want to compare model AIC values to
null = models.sca %>%
  arrange(df) %>%
  filter(health == "+" & liking == "+" & df == 5)

# tidy for plotting
plot.data = models.sca %>%
  arrange(AIC) %>%
  mutate(specification = row_number(),
         better.fit = ifelse(AIC == null$AIC, "equal",
                      ifelse(AIC < null$AIC, "yes", "no")))

order = plot.data %>%
  arrange(AIC) %>%
  mutate(better.fit.num = ifelse(better.fit == "yes", 1, 0)) %>%
  gather(variable, value, -c(AIC, delta, BIC, df, logLik, weight, better.fit.num, specification, better.fit)) %>%
  filter(!is.na(value)) %>%
  group_by(variable) %>%
  mutate(order = sum(better.fit.num)) %>%
  select(variable, order) %>%
  unique()

# variables included in model
variable.names = names(select(plot.data, -starts_with("better"), -specification, -AIC, -BIC, -df, -logLik, -delta, -weight, -`(Intercept)`))

# plot top panel
a = plot.data %>%
  ggplot(aes(specification, AIC, color = better.fit)) +
    geom_point(shape = "|", size = 4, alpha = .75) +
    geom_hline(yintercept = null$AIC, linetype = "dashed", color = "#5BBCD6") +
    scale_color_manual(values = c("#5BBCD6", "black", "#F43C13")) +
    labs(x = "", y = "AIC\n") +
    dc_bw +
    theme(legend.position = "none")
    # theme(#legend.title = element_text(size = 1),
    #       #legend.text = element_text(size = 9))

# set plotting order for variables based on number of times it's included in better fitting models
b = plot.data %>%
  gather(variable, value, eval(variable.names)) %>%
  left_join(., order, by = "variable") %>%
  mutate(value = ifelse(!is.na(value), "|", ""),
         variable = gsub("`regulate > look`", "regulate > look", variable),
         variable = gsub("`regulate > rest`", "regulate > rest", variable),
         variable = gsub("`logistic classifier`", "logistic classifier", variable),
         variable = gsub("regulate > look:liking", "liking:regulate > look", variable),
         variable = gsub("regulate > rest:liking", "liking:regulate > rest", variable),
         variable = gsub("logistic classifier:liking", "liking:logistic classifier", variable),
         variable = gsub("liking:", "liking  x  ", variable),
         variable = gsub("regulate > look:health", "health:regulate > look", variable),
         variable = gsub("regulate > rest:health", "health:regulate > rest", variable),
         variable = gsub("logistic classifier:health", "health:logistic classifier", variable),
         variable = gsub("health:", "health  x  ", variable),
         variable = gsub("health", "food type", variable)) %>%
  ggplot(aes(specification, reorder(variable, order), color = better.fit)) +
    geom_text(aes(label = value), alpha = .75) +
    scale_color_manual(values = c("#5BBCD6", "black", "#F43C13")) +
    labs(x = "\nspecification number", y = "variables\n") +
    dc_bw +
    theme(legend.position = "none")
    # theme(#legend.title = element_text(size = 1),
    #       #legend.text = element_text(size = 9))

plot_grid(a, b, ncol = 1, align = "v")
```